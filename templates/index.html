<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial News Analysis</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2rem; background-color: #f8f9fa; color: #212529;}
        .top-bar { display: flex; justify-content: space-between; align-items: stretch; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .widget { background-color: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .widget h2 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6c757d; text-transform: uppercase; }
        .widget p { margin: 0; font-size: 1.75rem; font-weight: 500; }
        #monthly-summary p { display: flex; gap: 1rem; }
        .summary-value { display: flex; align-items: center; gap: 0.5rem; }
        .positive-text { color: #28a745; }
        .negative-text { color: #dc3545; }
        .date-nav { display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .date-nav h1 { margin: 0; font-size: 1.5rem; }
        .date-nav button { font-size: 2rem; background: none; border: none; cursor: pointer; color: #007bff; padding: 0 10px;}
        .date-nav button:disabled { color: #ccc; }
        #clock { font-size: 1.5rem; }
        .controls { display: flex; align-items: center; gap: 1rem; }
        .switch { position: relative; display: inline-block; width: 120px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(86px); }
        .switch-labels { color: #fff; position: absolute; width: 100%; top: 50%; transform: translateY(-50%); display: flex; justify-content: space-around; font-size: 0.75rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; border: 1px solid #dee2e6; text-align: left; }
        thead { background-color: #e9ecef; }
        #articles-tbody { transition: opacity 0.3s ease-in-out; }
        #articles-tbody.loading { opacity: 0; }
        .sentiment { font-weight: bold; }
        .sentiment.POSITIVE { color: #28a745; }
        .sentiment.NEGATIVE { color: #dc3545; }
        .sentiment.NEUTRAL { color: #6c757d; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="widget" id="monthly-summary">
            <h2>This Month's Summary</h2>
            <p>
                <span class="summary-value positive-text" id="monthly-positive">...</span>
                <span class="summary-value negative-text" id="monthly-negative">...</span>
            </p>
        </div>
        <div class="widget" id="daily-count">
            <h2>Today's News Count</h2>
            <p id="daily-count-value">...</p>
        </div>
        <div class="widget controls">
            <label class="switch" title="Toggle AI Confidence Level">
                <input type="checkbox" id="confidence-toggle">
                <span class="slider"></span>
                <div class="switch-labels"><span>All</span><span>High</span></div>
            </label>
            <div class="date-nav">
                <button id="btn-prev" title="Previous Day">&lt;</button>
                <h1 id="date-title">...</h1>
                <button id="btn-next" title="Next Day">&gt;</button>
            </div>
            <span id="clock"></span>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Brief</th>
                <th>Subject Company</th>
                <th>Sentiment</th>
                <th>Confidence</th>
                <th>Published At</th>
            </tr>
        </thead>
        <tbody id="articles-tbody"></tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentDate = new Date();
            let confidenceLevel = 'all'; // 'all' or 'high'
            let autoRefreshIntervalId = null;

            const dateTitle = document.getElementById('date-title');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const clockElement = document.getElementById('clock');
            const articlesTbody = document.getElementById('articles-tbody');
            const confidenceToggle = document.getElementById('confidence-toggle');
            const dailyCountValue = document.getElementById('daily-count-value');
            const monthlyPositive = document.getElementById('monthly-positive');
            const monthlyNegative = document.getElementById('monthly-negative');

            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
            const toYYYYMMDD = (date) => date.toISOString().split('T')[0];

            function updateClock() {
                clockElement.textContent = new Date().toLocaleTimeString('en-GB');
            }

            function updateUIState() {
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);
                if (isSameDay(currentDate, today)) dateTitle.textContent = "Today";
                else if (isSameDay(currentDate, yesterday)) dateTitle.textContent = "Yesterday";
                else dateTitle.textContent = currentDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                btnNext.disabled = currentDate >= new Date().setHours(0, 0, 0, 0);
            }

            async function updateDashboard(showLoading = true) {
                if (isSameDay(currentDate, new Date())) startAutoRefresh();
                else stopAutoRefresh();

                const dateStr = toYYYYMMDD(currentDate);
                const params = `?date=${dateStr}&confidence=${confidenceLevel}`;

                if (showLoading) articlesTbody.classList.add('loading');
                updateUIState();

                // Fetch both summary and articles in parallel
                const [summaryData, articlesData] = await Promise.all([
                    fetch(`/api/summary?confidence=${confidenceLevel}`).then(res => res.json()),
                    fetch(`/api/articles${params}`).then(res => res.json())
                ]);
                
                // Update summary widgets
                dailyCountValue.textContent = summaryData.daily_count || 0;
                monthlyPositive.textContent = `+${summaryData.monthly_positive || 0}`;
                monthlyNegative.textContent = `-${summaryData.monthly_negative || 0}`;

                // Update articles table with fade effect
                setTimeout(() => {
                    articlesTbody.innerHTML = '';
                    if (articlesData.length > 0) {
                        articlesData.forEach(article => {
                            const confidencePercent = (article.confidence * 100).toFixed(2);
                            const row = `
                                <tr>
                                    <td>${article.content}</td>
                                    <td>${article.company || 'N/A'}</td>
                                    <td class="sentiment ${article.sentiment}">${article.sentiment}</td>
                                    <td>${confidencePercent}%</td>
                                    <td>${article.time}</td>
                                </tr>
                            `;
                            articlesTbody.innerHTML += row;
                        });
                    } else {
                        articlesTbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No processed articles found for this day.</td></tr>`;
                    }
                    articlesTbody.classList.remove('loading');
                }, 300);
            }

            function stopAutoRefresh() { if (autoRefreshIntervalId) clearInterval(autoRefreshIntervalId); }
            function startAutoRefresh() {
                stopAutoRefresh();
                autoRefreshIntervalId = setInterval(() => updateDashboard(false), 30000);
            }

            // Event Listeners
            btnPrev.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); updateDashboard(); });
            btnNext.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); updateDashboard(); });
            confidenceToggle.addEventListener('change', (e) => {
                confidenceLevel = e.target.checked ? 'high' : 'all';
                updateDashboard();
            });

            // Initial Load
            updateClock();
            setInterval(updateClock, 1000);
            updateDashboard();
        });
    </script>
</body>
</html>